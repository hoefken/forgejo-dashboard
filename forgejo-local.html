<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgejo Pipeline Monitor</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'JetBrains Mono', monospace; }
    input::placeholder, textarea::placeholder { color: #444; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinning { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // Lucide Icons als SVG-Komponenten
    const Icon = ({ d, size = 18, style = {} }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <path d={d} />
      </svg>
    );

    const Icons = {
      RefreshCw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>,
      CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
      XCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
      Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      AlertCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
      PlayCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>,
      Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>,
      Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
      Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
      ExternalLink: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
      GitBranch: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 01-9 9"/></svg>,
      Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
      ChevronDown: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
      ChevronRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
    };

    const STATUS_MAP = {
      success: { color: '#22c55e', bg: '#052e16', icon: 'CheckCircle', label: 'Success', priority: 1 },
      failure: { color: '#ef4444', bg: '#450a0a', icon: 'XCircle', label: 'Failed', priority: 4 },
      cancelled: { color: '#6b7280', bg: '#1f2937', icon: 'AlertCircle', label: 'Cancelled', priority: 2 },
      running: { color: '#3b82f6', bg: '#172554', icon: 'PlayCircle', label: 'Running', priority: 3 },
      waiting: { color: '#f59e0b', bg: '#451a03', icon: 'Clock', label: 'Waiting', priority: 3 },
      pending: { color: '#f59e0b', bg: '#451a03', icon: 'Clock', label: 'Pending', priority: 3 },
      skipped: { color: '#6b7280', bg: '#1f2937', icon: 'AlertCircle', label: 'Skipped', priority: 1 },
      unknown: { color: '#6b7280', bg: '#1f2937', icon: 'AlertCircle', label: 'Unknown', priority: 0 },
    };

    const getStatus = (status, conclusion) => {
      if (status === 'completed') return STATUS_MAP[conclusion] || STATUS_MAP.unknown;
      return STATUS_MAP[status] || STATUS_MAP.unknown;
    };

    const formatDuration = (start, end) => {
      if (!start) return '-';
      const diff = Math.floor((new Date(end || Date.now()) - new Date(start)) / 1000);
      if (diff < 60) return `${diff}s`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ${diff % 60}s`;
      return `${Math.floor(diff / 3600)}h ${Math.floor((diff % 3600) / 60)}m`;
    };

    const formatTimeAgo = (date) => {
      if (!date) return '-';
      const diff = Math.floor((Date.now() - new Date(date)) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    };

    const getWorkflowName = (run) => {
      if (run.workflow_ref) {
        const match = run.workflow_ref.match(/workflows\/([^@]+)/);
        if (match) return match[1].replace(/\.(yml|yaml)$/, '');
      }
      return run.name || run.workflow_id || 'unknown';
    };

    const getJobPath = (repoFullName, run) => `${repoFullName}/${getWorkflowName(run)}`;

    function ForgejoDashboard() {
      const [config, setConfig] = useState({
        baseUrl: '',
        token: '',
        repoPattern: '.*amerigo.*',
        workflowPattern: '(build|continuous-delivery|check|pw-e2e/(.*test)|update-amerigo-dependencies)',
        branchPattern: '^main$',
        organizations: [],
      });
      
      const [discoveredRepos, setDiscoveredRepos] = useState([]);
      const [allRuns, setAllRuns] = useState([]);
      const [loading, setLoading] = useState(false);
      const [discovering, setDiscovering] = useState(false);
      const [error, setError] = useState(null);
      const [showSettings, setShowSettings] = useState(true);
      const [autoRefresh, setAutoRefresh] = useState(30);
      const [lastUpdate, setLastUpdate] = useState(null);
      const [newOrg, setNewOrg] = useState('');
      const [viewMode, setViewMode] = useState('grid');
      const [expandedRepos, setExpandedRepos] = useState(new Set());
      const [discoveryLog, setDiscoveryLog] = useState([]);

      useEffect(() => {
        const saved = localStorage.getItem('forgejo-dashboard-v2-config');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            setConfig(parsed);
            if (parsed.baseUrl && (parsed.organizations?.length > 0 || parsed.repoPattern)) {
              setShowSettings(false);
            }
          } catch (e) {}
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('forgejo-dashboard-v2-config', JSON.stringify(config));
      }, [config]);

      const addLog = (msg) => setDiscoveryLog(prev => [...prev.slice(-50), `${new Date().toLocaleTimeString()} - ${msg}`]);

      const apiCall = useCallback(async (endpoint) => {
        const sep = endpoint.includes('?') ? '&' : '?';
        const url = `${config.baseUrl}/api/v1${endpoint}${config.token ? `${sep}token=${config.token}` : ''}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return res.json();
      }, [config.baseUrl, config.token]);

      const fetchOrgRepos = useCallback(async (org) => {
        const repos = [];
        let page = 1;
        while (true) {
          try {
            const data = await apiCall(`/orgs/${org}/repos?page=${page}&limit=50`);
            if (!data?.length) break;
            repos.push(...data);
            if (data.length < 50) break;
            page++;
          } catch (err) {
            addLog(`‚ö†Ô∏è Fehler bei Org ${org}: ${err.message}`);
            break;
          }
        }
        return repos;
      }, [apiCall]);

      const searchRepos = useCallback(async (query) => {
        try {
          const data = await apiCall(`/repos/search?q=${encodeURIComponent(query)}&limit=100`);
          return data.data || data || [];
        } catch (err) {
          addLog(`‚ö†Ô∏è Suche fehlgeschlagen: ${err.message}`);
          return [];
        }
      }, [apiCall]);

      const fetchRepoRuns = useCallback(async (owner, repo) => {
        try {
          const data = await apiCall(`/repos/${owner}/${repo}/actions/runs?limit=20`);
          return data.workflow_runs || data || [];
        } catch (err) {
          if (!err.message.includes('404')) addLog(`‚ö†Ô∏è Runs f√ºr ${owner}/${repo}: ${err.message}`);
          return [];
        }
      }, [apiCall]);

      const discoverJobs = useCallback(async () => {
        if (!config.baseUrl) return;
        setDiscovering(true);
        setDiscoveryLog([]);
        setError(null);
        
        try {
          let allRepos = [];
          
          for (const org of config.organizations) {
            addLog(`üîç Durchsuche Organisation: ${org}`);
            const repos = await fetchOrgRepos(org);
            addLog(`   ‚Üí ${repos.length} Repos gefunden`);
            allRepos.push(...repos);
          }
          
          if (config.repoPattern && config.repoPattern !== '.*') {
            const searchTerm = config.repoPattern.replace(/\.\*/g, '').replace(/[^a-zA-Z0-9-_]/g, '').slice(0, 20);
            if (searchTerm.length >= 2) {
              addLog(`üîç Suche nach Repos mit: "${searchTerm}"`);
              const searchResults = await searchRepos(searchTerm);
              addLog(`   ‚Üí ${searchResults.length} Repos gefunden`);
              const existingIds = new Set(allRepos.map(r => r.id));
              allRepos.push(...searchResults.filter(r => !existingIds.has(r.id)));
            }
          }
          
          let repoRegex;
          try { repoRegex = new RegExp(config.repoPattern, 'i'); } 
          catch (e) { addLog(`‚ö†Ô∏è Ung√ºltiges Repo-Pattern: ${e.message}`); repoRegex = /.*/; }
          
          const matchingRepos = allRepos.filter(repo => repoRegex.test(repo.full_name) || repoRegex.test(repo.name));
          addLog(`‚úÖ ${matchingRepos.length} Repos entsprechen dem Pattern`);
          setDiscoveredRepos(matchingRepos);
          
          const allRunsCollected = [];
          for (const repo of matchingRepos) {
            addLog(`üì• Lade Runs f√ºr: ${repo.full_name}`);
            const runs = await fetchRepoRuns(repo.owner.login || repo.owner.username, repo.name);
            allRunsCollected.push(...runs.map(run => ({
              ...run, _repo: repo, _repoFullName: repo.full_name, _jobPath: getJobPath(repo.full_name, run),
            })));
          }
          
          addLog(`‚úÖ Insgesamt ${allRunsCollected.length} Runs geladen`);
          setAllRuns(allRunsCollected);
          setLastUpdate(new Date());
        } catch (err) {
          setError(err.message);
          addLog(`‚ùå Fehler: ${err.message}`);
        } finally {
          setDiscovering(false);
        }
      }, [config, fetchOrgRepos, searchRepos, fetchRepoRuns]);

      const refreshRuns = useCallback(async () => {
        if (!config.baseUrl || !discoveredRepos.length) return;
        setLoading(true);
        try {
          const allRunsCollected = [];
          for (const repo of discoveredRepos) {
            const runs = await fetchRepoRuns(repo.owner.login || repo.owner.username, repo.name);
            allRunsCollected.push(...runs.map(run => ({
              ...run, _repo: repo, _repoFullName: repo.full_name, _jobPath: getJobPath(repo.full_name, run),
            })));
          }
          setAllRuns(allRunsCollected);
          setLastUpdate(new Date());
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }, [config.baseUrl, discoveredRepos, fetchRepoRuns]);

      const filteredAndGroupedJobs = useMemo(() => {
        let workflowRegex;
        try { workflowRegex = new RegExp(config.workflowPattern, 'i'); }
        catch (e) { workflowRegex = /.*/; }

        let branchRegex;
        try { branchRegex = config.branchPattern ? new RegExp(config.branchPattern, 'i') : null; }
        catch (e) { branchRegex = null; }

        const filtered = allRuns.filter(run => {
          const wfName = getWorkflowName(run);
          const matchesWorkflow = workflowRegex.test(wfName) || workflowRegex.test(run._jobPath);
          const matchesBranch = !branchRegex || branchRegex.test(run.head_branch || '');
          return matchesWorkflow && matchesBranch;
        });
        
        const jobMap = new Map();
        for (const run of filtered) {
          const key = run._jobPath;
          const existing = jobMap.get(key);
          if (!existing || new Date(run.created_at) > new Date(existing.latestRun.created_at)) {
            jobMap.set(key, {
              jobPath: key, repo: run._repo, repoFullName: run._repoFullName,
              workflowName: getWorkflowName(run), latestRun: run,
              allRuns: existing ? [...existing.allRuns, run] : [run],
            });
          } else {
            existing.allRuns.push(run);
          }
        }
        
        for (const job of jobMap.values()) {
          job.allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          job.allRuns = job.allRuns.slice(0, 10);
        }
        
        return Array.from(jobMap.values()).sort((a, b) => {
          const sA = getStatus(a.latestRun.status, a.latestRun.conclusion);
          const sB = getStatus(b.latestRun.status, b.latestRun.conclusion);
          return sB.priority - sA.priority;
        });
      }, [allRuns, config.workflowPattern, config.branchPattern]);

      useEffect(() => {
        if (!discoveredRepos.length || !config.baseUrl || !autoRefresh) return;
        const interval = setInterval(refreshRuns, autoRefresh * 1000);
        return () => clearInterval(interval);
      }, [discoveredRepos, config.baseUrl, autoRefresh, refreshRuns]);

      const addOrg = () => {
        if (newOrg && !config.organizations.includes(newOrg)) {
          setConfig(prev => ({ ...prev, organizations: [...prev.organizations, newOrg] }));
          setNewOrg('');
        }
      };

      const removeOrg = (org) => setConfig(prev => ({ ...prev, organizations: prev.organizations.filter(o => o !== org) }));

      const getOverallStatus = () => {
        if (!filteredAndGroupedJobs.length) return 'unknown';
        const statuses = filteredAndGroupedJobs.map(j => j.latestRun.status === 'completed' ? j.latestRun.conclusion : j.latestRun.status);
        if (statuses.includes('failure')) return 'failure';
        if (statuses.includes('running')) return 'running';
        if (statuses.includes('pending') || statuses.includes('waiting')) return 'pending';
        if (statuses.every(s => s === 'success')) return 'success';
        return 'unknown';
      };

      const overallStatus = getOverallStatus();
      const statusInfo = getStatus(overallStatus === 'success' ? 'completed' : overallStatus, overallStatus);
      const StatusIcon = Icons[statusInfo.icon];

      const jobsByRepo = useMemo(() => {
        const grouped = new Map();
        for (const job of filteredAndGroupedJobs) {
          if (!grouped.has(job.repoFullName)) grouped.set(job.repoFullName, []);
          grouped.get(job.repoFullName).push(job);
        }
        return grouped;
      }, [filteredAndGroupedJobs]);

      const toggleRepoExpand = (name) => {
        setExpandedRepos(prev => {
          const next = new Set(prev);
          next.has(name) ? next.delete(name) : next.add(name);
          return next;
        });
      };

      return (
        <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 100%)', color: '#e5e5e5', fontFamily: "'JetBrains Mono', monospace" }}>
          {/* Header */}
          <header style={{ background: 'rgba(0,0,0,0.5)', borderBottom: '1px solid #2a2a2a', padding: '0.75rem 1.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, zIndex: 100, backdropFilter: 'blur(10px)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
              <div style={{ width: 36, height: 36, background: 'linear-gradient(135deg, #f97316, #ea580c)', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Icons.Activity width={20} height={20} style={{ color: 'white' }} />
              </div>
              <div>
                <h1 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 700, color: '#fff' }}>Forgejo Pipeline Monitor</h1>
                <p style={{ margin: 0, fontSize: '0.65rem', color: '#666', letterSpacing: '0.15em', textTransform: 'uppercase' }}>localhost Dashboard</p>
              </div>
            </div>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
              {lastUpdate && <span style={{ fontSize: '0.7rem', color: '#555' }}>{lastUpdate.toLocaleTimeString()}</span>}
              <select value={autoRefresh} onChange={e => setAutoRefresh(Number(e.target.value))} style={{ background: '#1a1a1a', border: '1px solid #333', borderRadius: 4, padding: '0.4rem 0.6rem', color: '#999', fontSize: '0.7rem' }}>
                <option value={0}>Manual</option>
                <option value={10}>10s</option>
                <option value={30}>30s</option>
                <option value={60}>60s</option>
              </select>
              <div style={{ display: 'flex', border: '1px solid #333', borderRadius: 4, overflow: 'hidden' }}>
                <button onClick={() => setViewMode('grid')} style={{ background: viewMode === 'grid' ? '#333' : 'transparent', border: 'none', padding: '0.4rem 0.6rem', color: viewMode === 'grid' ? '#fff' : '#666', cursor: 'pointer', fontSize: '0.7rem' }}>Grid</button>
                <button onClick={() => setViewMode('table')} style={{ background: viewMode === 'table' ? '#333' : 'transparent', border: 'none', padding: '0.4rem 0.6rem', color: viewMode === 'table' ? '#fff' : '#666', cursor: 'pointer', fontSize: '0.7rem' }}>Table</button>
              </div>
              <button onClick={refreshRuns} disabled={loading || !discoveredRepos.length} style={{ background: '#1a1a1a', border: '1px solid #333', borderRadius: 4, padding: '0.4rem 0.8rem', color: '#999', cursor: loading ? 'wait' : 'pointer', display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem' }}>
                <Icons.RefreshCw width={14} height={14} className={loading ? 'spinning' : ''} />Refresh
              </button>
              <button onClick={() => setShowSettings(!showSettings)} style={{ background: showSettings ? '#333' : '#1a1a1a', border: '1px solid #333', borderRadius: 4, padding: '0.4rem', color: showSettings ? '#fff' : '#666', cursor: 'pointer' }}>
                <Icons.Settings width={18} height={18} />
              </button>
            </div>
          </header>

          {/* Status Bar */}
          {filteredAndGroupedJobs.length > 0 && (
            <div style={{ background: statusInfo.bg, borderBottom: `2px solid ${statusInfo.color}`, padding: '0.5rem 1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                <StatusIcon width={18} height={18} style={{ color: statusInfo.color }} />
                <span style={{ fontSize: '0.8rem', fontWeight: 600, color: statusInfo.color }}>
                  {filteredAndGroupedJobs.length} Jobs
                  {overallStatus === 'success' && ' ‚Äî All Passing'}
                  {overallStatus === 'failure' && ` ‚Äî ${filteredAndGroupedJobs.filter(j => j.latestRun.conclusion === 'failure').length} Failing`}
                  {overallStatus === 'running' && ` ‚Äî ${filteredAndGroupedJobs.filter(j => j.latestRun.status === 'running').length} Running`}
                </span>
              </div>
              <div style={{ display: 'flex', gap: '1rem', fontSize: '0.7rem', color: '#888' }}>
                <span>‚úì {filteredAndGroupedJobs.filter(j => j.latestRun.conclusion === 'success').length}</span>
                <span style={{ color: '#ef4444' }}>‚úó {filteredAndGroupedJobs.filter(j => j.latestRun.conclusion === 'failure').length}</span>
                <span style={{ color: '#3b82f6' }}>‚óè {filteredAndGroupedJobs.filter(j => j.latestRun.status === 'running').length}</span>
              </div>
            </div>
          )}

          <div style={{ display: 'flex', minHeight: 'calc(100vh - 120px)' }}>
            {/* Settings Panel */}
            {showSettings && (
              <div style={{ width: 320, flexShrink: 0, background: '#141414', borderRight: '1px solid #2a2a2a', padding: '1.25rem', overflowY: 'auto' }}>
                <h2 style={{ margin: '0 0 1.25rem 0', fontSize: '0.7rem', fontWeight: 600, color: '#666', letterSpacing: '0.1em', textTransform: 'uppercase' }}>Configuration</h2>
                
                <div style={{ marginBottom: '1.25rem' }}>
                  <label style={{ display: 'block', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Forgejo URL</label>
                  <input type="text" value={config.baseUrl} onChange={e => setConfig(p => ({ ...p, baseUrl: e.target.value.replace(/\/$/, '') }))} placeholder="https://git.example.com" style={{ width: '100%', background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.6rem', color: '#e5e5e5', fontSize: '0.8rem' }} />
                </div>
                
                <div style={{ marginBottom: '1.25rem' }}>
                  <label style={{ display: 'block', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>API Token</label>
                  <input type="password" value={config.token} onChange={e => setConfig(p => ({ ...p, token: e.target.value }))} placeholder="your-api-token" style={{ width: '100%', background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.6rem', color: '#e5e5e5', fontSize: '0.8rem' }} />
                </div>
                
                <div style={{ marginBottom: '1.25rem' }}>
                  <label style={{ display: 'block', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Organizations to scan</label>
                  <div style={{ display: 'flex', gap: '0.4rem', marginBottom: '0.5rem' }}>
                    <input type="text" value={newOrg} onChange={e => setNewOrg(e.target.value)} onKeyPress={e => e.key === 'Enter' && addOrg()} placeholder="org-name" style={{ flex: 1, background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.5rem', color: '#e5e5e5', fontSize: '0.8rem' }} />
                    <button onClick={addOrg} style={{ background: '#1a472a', border: '1px solid #22c55e40', borderRadius: 4, padding: '0.5rem 0.75rem', color: '#22c55e', cursor: 'pointer' }}>+</button>
                  </div>
                  {config.organizations.length > 0 && (
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                      {config.organizations.map(org => (
                        <span key={org} style={{ display: 'inline-flex', alignItems: 'center', gap: '0.4rem', background: '#1a1a1a', border: '1px solid #333', borderRadius: 4, padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}>
                          {org}
                          <button onClick={() => removeOrg(org)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', padding: 0, display: 'flex' }}>
                            <Icons.Trash2 width={12} height={12} />
                          </button>
                        </span>
                      ))}
                    </div>
                  )}
                </div>
                
                <div style={{ marginBottom: '1.25rem' }}>
                  <label style={{ display: 'block', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Repository Pattern (Regex)</label>
                  <input type="text" value={config.repoPattern} onChange={e => setConfig(p => ({ ...p, repoPattern: e.target.value }))} placeholder=".*amerigo.*" style={{ width: '100%', background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.6rem', color: '#f97316', fontSize: '0.8rem', fontFamily: 'monospace' }} />
                </div>
                
                <div style={{ marginBottom: '1.25rem' }}>
                  <label style={{ display: 'block', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Workflow Pattern (Regex)</label>
                  <textarea value={config.workflowPattern} onChange={e => setConfig(p => ({ ...p, workflowPattern: e.target.value }))} placeholder="(build|test)" rows={3} style={{ width: '100%', background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.6rem', color: '#8b5cf6', fontSize: '0.8rem', fontFamily: 'monospace', resize: 'vertical' }} />
                </div>

                <div style={{ marginBottom: '1.5rem' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.7rem', color: '#555', marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                    <Icons.GitBranch width={12} height={12} />
                    Branch Pattern (Regex)
                  </label>
                  <input type="text" value={config.branchPattern} onChange={e => setConfig(p => ({ ...p, branchPattern: e.target.value }))} placeholder="^main$" style={{ width: '100%', background: '#0a0a0a', border: '1px solid #333', borderRadius: 4, padding: '0.6rem', color: '#22d3ee', fontSize: '0.8rem', fontFamily: 'monospace' }} />
                  <span style={{ display: 'block', fontSize: '0.6rem', color: '#444', marginTop: '0.3rem' }}>Default: ^main$ (nur main-Branch). Leer lassen f√ºr alle Branches.</span>
                </div>
                
                <button onClick={discoverJobs} disabled={discovering || !config.baseUrl} style={{ width: '100%', background: 'linear-gradient(135deg, #f97316, #ea580c)', border: 'none', borderRadius: 6, padding: '0.75rem', color: 'white', cursor: discovering ? 'wait' : 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem', fontSize: '0.85rem', fontWeight: 600, opacity: discovering || !config.baseUrl ? 0.6 : 1 }}>
                  {discovering ? <><Icons.RefreshCw width={16} height={16} className="spinning" />Discovering...</> : <><Icons.Search width={16} height={16} />Discover Jobs</>}
                </button>
                
                {discoveryLog.length > 0 && (
                  <div style={{ marginTop: '1rem', background: '#0a0a0a', border: '1px solid #222', borderRadius: 4, padding: '0.75rem', maxHeight: 200, overflowY: 'auto', fontSize: '0.65rem', fontFamily: 'monospace', color: '#666' }}>
                    {discoveryLog.map((log, i) => <div key={i} style={{ marginBottom: '0.25rem' }}>{log}</div>)}
                  </div>
                )}
                
                {discoveredRepos.length > 0 && (
                  <div style={{ marginTop: '1rem', padding: '0.75rem', background: '#1a1a1a', borderRadius: 6, fontSize: '0.7rem', color: '#666' }}>
                    <div><strong style={{ color: '#888' }}>{discoveredRepos.length}</strong> Repos discovered</div>
                    <div><strong style={{ color: '#888' }}>{allRuns.length}</strong> Total runs loaded</div>
                    <div><strong style={{ color: '#888' }}>{filteredAndGroupedJobs.length}</strong> Jobs matching filters</div>
                  </div>
                )}
              </div>
            )}

            {/* Main Content */}
            <div style={{ flex: 1, padding: '1.25rem', overflowY: 'auto' }}>
              {error && <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: 6, padding: '1rem', marginBottom: '1rem', color: '#fca5a5', fontSize: '0.85rem' }}>‚ö†Ô∏è {error}</div>}
              
              {!filteredAndGroupedJobs.length ? (
                <div style={{ textAlign: 'center', padding: '4rem 2rem', color: '#444' }}>
                  <Icons.Search width={48} height={48} style={{ marginBottom: '1rem', opacity: 0.3 }} />
                  <h2 style={{ margin: '0 0 0.5rem 0', color: '#555', fontWeight: 500 }}>{!discoveredRepos.length ? 'No Jobs Discovered' : 'No Matching Workflows'}</h2>
                  <p style={{ margin: 0, fontSize: '0.85rem' }}>{!discoveredRepos.length ? 'Configure organizations and patterns, then click "Discover Jobs"' : 'Adjust your workflow pattern to find matching jobs'}</p>
                </div>
              ) : viewMode === 'table' ? (
                <div style={{ background: '#141414', border: '1px solid #2a2a2a', borderRadius: 8, overflow: 'hidden' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.8rem' }}>
                    <thead>
                      <tr style={{ background: '#1a1a1a', borderBottom: '1px solid #2a2a2a' }}>
                        <th style={{ padding: '0.75rem 1rem', textAlign: 'left', color: '#666', fontWeight: 500, width: 40 }}>S</th>
                        <th style={{ padding: '0.75rem 1rem', textAlign: 'left', color: '#666', fontWeight: 500 }}>Job</th>
                        <th style={{ padding: '0.75rem 1rem', textAlign: 'left', color: '#666', fontWeight: 500, width: 120 }}>Last Build</th>
                        <th style={{ padding: '0.75rem 1rem', textAlign: 'left', color: '#666', fontWeight: 500, width: 100 }}>Duration</th>
                        <th style={{ padding: '0.75rem 1rem', textAlign: 'center', color: '#666', fontWeight: 500, width: 80 }}>History</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Array.from(jobsByRepo.entries()).map(([repoName, jobs]) => (
                        <React.Fragment key={repoName}>
                          <tr style={{ background: '#0d0d0d', cursor: 'pointer', borderBottom: '1px solid #222' }} onClick={() => toggleRepoExpand(repoName)}>
                            <td colSpan={5} style={{ padding: '0.5rem 1rem' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                {expandedRepos.has(repoName) ? <Icons.ChevronDown width={14} height={14} /> : <Icons.ChevronRight width={14} height={14} />}
                                <span style={{ color: '#888', fontWeight: 500 }}>{repoName}</span>
                                <span style={{ color: '#444', fontSize: '0.7rem' }}>({jobs.length} workflows)</span>
                              </div>
                            </td>
                          </tr>
                          {(expandedRepos.has(repoName) || !expandedRepos.size) && jobs.map(job => {
                            const status = getStatus(job.latestRun.status, job.latestRun.conclusion);
                            return (
                              <tr key={job.jobPath} style={{ borderBottom: '1px solid #1a1a1a' }}>
                                <td style={{ padding: '0.6rem 1rem' }}><div style={{ width: 12, height: 12, borderRadius: '50%', background: status.color, boxShadow: `0 0 8px ${status.color}60` }} /></td>
                                <td style={{ padding: '0.6rem 1rem' }}>
                                  <a href={`${config.baseUrl}/${job.repoFullName}/actions`} target="_blank" rel="noopener noreferrer" style={{ color: '#e5e5e5', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ color: '#888' }}>{job.workflowName}</span>
                                    <Icons.ExternalLink width={12} height={12} style={{ color: '#444' }} />
                                  </a>
                                </td>
                                <td style={{ padding: '0.6rem 1rem', color: '#666' }}>{formatTimeAgo(job.latestRun.created_at)}</td>
                                <td style={{ padding: '0.6rem 1rem', color: '#666' }}>{formatDuration(job.latestRun.started_at, job.latestRun.completed_at)}</td>
                                <td style={{ padding: '0.6rem 1rem' }}>
                                  <div style={{ display: 'flex', justifyContent: 'center', gap: 2 }}>
                                    {job.allRuns.slice(0, 8).map((run, i) => {
                                      const s = getStatus(run.status, run.conclusion);
                                      return <a key={run.id || i} href={`${config.baseUrl}/${job.repoFullName}/actions/runs/${run.id}`} target="_blank" rel="noopener noreferrer" title={`#${run.run_number || i + 1} - ${s.label}`} style={{ width: 14, height: 14, borderRadius: 2, background: s.color, opacity: i === 0 ? 1 : 0.6 }} />;
                                    })}
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                  {filteredAndGroupedJobs.map(job => {
                    const status = getStatus(job.latestRun.status, job.latestRun.conclusion);
                    const JobStatusIcon = Icons[status.icon];
                    return (
                      <div key={job.jobPath} style={{ background: '#141414', border: `1px solid ${status.color}30`, borderLeft: `3px solid ${status.color}`, borderRadius: 6, overflow: 'hidden' }}>
                        <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid #222', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{ fontSize: '0.85rem', fontWeight: 600, color: '#e5e5e5', marginBottom: '0.25rem' }}>{job.workflowName}</div>
                            <div style={{ fontSize: '0.7rem', color: '#555' }}>{job.repoFullName}</div>
                          </div>
                          <JobStatusIcon width={18} height={18} style={{ color: status.color }} />
                        </div>
                        <div style={{ padding: '0.75rem 1rem' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem', fontSize: '0.75rem' }}>
                            <span style={{ color: '#666' }}><Icons.GitBranch width={12} height={12} style={{ marginRight: '0.25rem', verticalAlign: 'middle' }} />{job.latestRun.head_branch || 'main'}</span>
                            <span style={{ color: '#555' }}>{formatTimeAgo(job.latestRun.created_at)}</span>
                          </div>
                          <div style={{ display: 'flex', gap: 3 }}>
                            {job.allRuns.slice(0, 10).map((run, i) => {
                              const s = getStatus(run.status, run.conclusion);
                              return <a key={run.id || i} href={`${config.baseUrl}/${job.repoFullName}/actions/runs/${run.id}`} target="_blank" rel="noopener noreferrer" title={`#${run.run_number || i + 1} - ${s.label}`} style={{ flex: 1, height: 20, borderRadius: 2, background: s.color, opacity: i === 0 ? 1 : 0.5 }} />;
                            })}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ForgejoDashboard />);
  </script>
</body>
</html>
